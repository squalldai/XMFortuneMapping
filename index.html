<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>åŠ å¯†è§£å¯†å·¥å…· v1.8.3</title>
<style>
  :root{
    --blue:#4cafef;
    --orange:#ff7043;
    --bg:#f0f2f5;
    --card:#ffffff;
    --text:#333;
    --muted:#555;
    --hint:#777;
    --shadow:0 4px 12px rgba(0,0,0,0.1);
  }
  *{box-sizing:border-box}
  body{
    font-family:Arial,Helvetica,sans-serif;
    background:var(--bg);
    margin:0; padding:0; text-align:center; color:var(--text);
  }
  header{
    background:linear-gradient(135deg,#ffecd2,#fcb69f);
    height:12vh; min-height:64px;
    display:flex; align-items:center; justify-content:center;
    font-size:1.95rem; font-weight:700; color:#333;
    box-shadow:0 2px 8px rgba(0,0,0,0.1);
  }
  .container{
    max-width:480px; margin:10px auto; padding:12px 16px;
    background:var(--card); border-radius:16px; box-shadow:var(--shadow);
  }
  .info-module{
    background:rgba(240,240,240,0.8);
    border-radius:12px; padding:12px; text-align:left;
    font-size:0.86rem; font-style:italic; color:#444; margin-bottom:12px;
  }
  h2{ margin:10px 0 6px; font-size:1.08rem; color:#444; }
  .radio-group{
    margin:6px 0 12px; display:flex; justify-content:center; gap:14px; flex-wrap:wrap;
  }
  label{ font-size:0.92rem; color:#333; }
  .calc-container{
    border-radius:14px; padding:10px; transition:background 0.5s, box-shadow 0.3s;
    backdrop-filter:saturate(120%) blur(2px);
  }
  .io-block{
    margin:6px 0; text-align:left; border-radius:10px; padding:8px; transition:background 0.5s;
  }
  .io-label{
    display:block; margin-bottom:6px; font-size:0.88rem; font-weight:700; color:#555;
  }
  .input-row{ display:flex; align-items:center; gap:8px; }
  .prefix-input{
    width:110px; padding:8px; border:1px solid #d0d5dd; border-radius:8px; font-size:0.9rem; text-align:center;
    background:#fafafa;
  }
  input[type="text"]{
    flex:1; padding:10px; border:1px solid #d0d5dd; border-radius:8px; font-size:1.02rem; text-align:center;
    transition:box-shadow .2s, border-color .2s;
  }
  input[type="text"]:focus{ outline:none; border-color:#b7c9ff; box-shadow:0 0 0 3px rgba(71,124,255,0.15); }
  .button-calc{
    width:230px; padding:12px 0; border:none; border-radius:12px; font-size:1.08rem;
    cursor:pointer; margin:12px auto; color:#fff; display:block; transition:transform .15s, opacity .2s, background .2s;
  }
  .button-calc:hover{ transform:translateY(-1px); opacity:.95; }
  .button-calc:active{ transform:translateY(0); }
  #log{
    margin-top:12px; text-align:left; font-size:0.82rem; max-height:220px; overflow-y:auto;
    border-top:1px solid #e6e8ee; padding-top:8px;
  }
  .flash-encrypt{ background-color:rgba(76,175,239,.22); }
  .flash-decrypt{ background-color:rgba(255,112,67,.22); }

  /* ç´§å‡‘å¸ƒå±€ï¼Œä¿è¯é¦–å±çº¦90%å†…å¯è§ */
  @media (max-width:480px){
    header{ font-size:1.7rem; }
    .prefix-input{ width:100px; padding:7px; font-size:.9rem; }
    input[type="text"]{ padding:9px; font-size:1rem; }
    .button-calc{ width:220px; }
  }

  /* å°æç¤º */
  .hint{ font-size:0.78rem; color:#777; margin-top:2px; }
</style>
</head>
<body>
<header>åæ·»é¦™ç²¾ç¼–å·åŠ å¯†è§£å¯†å·¥å…· v1.8.3</header>

<div class="container">

  <!-- è¯´æ˜ï¼šå®Œæ•´å±•ç¤º -->
  <div class="info-module">
    å½“å‰ä»…æ”¯æŒ <strong>ADM æ¨¡å¼</strong>ï¼š<br>
    Â· åŠ å¯†ï¼šå·¦è¾“å…¥ 8 ä½æ•°å­—ï¼ˆä»¥ 7688 å¼€å¤´ï¼‰ï¼Œå³è¾“å…¥ 4 ä½æ•°å­— â†’ è¾“å‡º <strong>6 ä½</strong>å¤§å†™å­—æ¯/æ•°å­—ï¼ˆæ—  0/O/1/Iï¼‰ï¼Œå·¦ä¾§æ˜¾ç¤º HT-ã€‚<br>
    Â· è§£å¯†ï¼šè¾“å…¥ HT- ä¸å³ä¾§ 6 ä½ç¼–ç  â†’ è¿˜åŸä¸ºå·¦ä¾§ <strong>7688+4ä½æ•°å­—</strong>ï¼Œå³ä¾§ 4 ä½æ•°å­—ã€‚<br>
    Â· ç®—æ³•ä¸ºå¯†é’¥é©±åŠ¨çš„è½»é‡çº§æ´—ç‰Œï¼ˆFeistelï¼‰+ å®šé•¿ Base32 ç¼–ç ï¼Œ<strong>å®Œå…¨å¯é€†ã€æ— å¤§å‹æ˜ å°„è¡¨ã€æ‰§è¡Œå¿«é€Ÿ</strong>ã€‚
  </div>

  <h2>è¯·é€‰æ‹©æ¨¡å¼</h2>
  <div class="radio-group">
    <label><input type="radio" name="mode" value="ADM" checked> ADM</label>
    <label style="color:gray;"><input type="radio" name="mode" value="å¾·ä¹‹é¦¨" disabled> å¾·ä¹‹é¦¨ï¼ˆå¼€å‘ä¸­ï¼‰</label>
  </div>

  <h2>è¯·é€‰æ‹©æ“ä½œ</h2>
  <div class="radio-group">
    <label><input type="radio" name="operation" value="encrypt" checked> åŠ å¯†</label>
    <label><input type="radio" name="operation" value="decrypt"> è§£å¯†</label>
  </div>

  <!-- è®¡ç®—å¤§å®¹å™¨ï¼šè¾“å…¥åŒº + æŒ‰é’® + è¾“å‡ºåŒºï¼ˆæ•´ä½“é—ªçƒ/æ®‹ç•™ï¼‰ -->
  <div class="calc-container" id="calcContainer">
    <!-- è¾“å…¥ -->
    <div class="io-block" id="inputBlock">
      <span class="io-label">è¾“å…¥</span>
      <div class="input-row">
        <input type="text" id="prefixInput" class="prefix-input" value="76880800" autocomplete="off" inputmode="numeric" />
        <input type="text" id="mainInput" maxlength="4" placeholder="è¾“å…¥4ä½æ•°å­—" autocomplete="off" inputmode="numeric" />
      </div>
      <div class="hint" id="inputHint">åŠ å¯†ï¼šå·¦ 8 ä½ä¸”ä»¥ 7688 å¼€å¤´ï¼Œå³ 4 ä½æ•°å­—ï¼›è§£å¯†ï¼šå·¦ HT-ï¼Œå³ 6 ä½å¤§å†™å­—æ¯/æ•°å­—</div>
    </div>

    <!-- è®¡ç®—æŒ‰é’® -->
    <button class="button-calc" id="calcBtn" onclick="onCalculate()">ğŸ”’ è®¡ç®—</button>

    <!-- è¾“å‡º -->
    <div class="io-block" id="outputBlock">
      <span class="io-label">ç»“æœ</span>
      <div class="input-row">
        <input type="text" id="prefixOutput" class="prefix-input" value="HT-" readonly />
        <input type="text" id="output" readonly />
      </div>
    </div>
  </div>

  <div id="log"></div>
</div>

<script>
  // å›ºå®šå¯†é’¥ï¼ˆå†™æ­»ï¼‰
  const ADM_KEY = "ht1416";

  // ä¸æ˜“æ··æ·†çš„ 32 å­—ç¬¦é›†ï¼ˆæ—  0/O/1/Iï¼‰
  const ALPH = '23456789ABCDEFGHJKLMNPRSTUVWXYZ';
  const RADIX = ALPH.length; // 32

  // è½»é‡ä¼ªéšæœºï¼šæŠŠ key å‹æˆç§å­ï¼Œå¹¶æ··å…¥ round/x åš xorshift ä¸ä¹˜æ³•æ…æ‹Œ
  function roundPRF(x, round, keyStr) {
    let seed = 2166136261 >>> 0; // FNV-1a åˆå€¼
    for (let i = 0; i < keyStr.length; i++) {
      seed ^= keyStr.charCodeAt(i);
      seed = Math.imul(seed, 16777619) >>> 0;
    }
    let s = (seed ^ (round * 0x9E3779B9) ^ x) >>> 0;
    s ^= s << 13; s >>>= 0;
    s ^= s >>> 17; s >>>= 0;
    s ^= s << 5;  s >>>= 0;
    s = Math.imul(s ^ 0x85EBCA6B, 0xC2B2AE35) >>> 0;
    return s & 0xFFFF; // 16-bit
  }

  // Feistel 6 è½®ï¼ˆå¯é€†ï¼‰ï¼Œä½œç”¨åœ¨ 8 ä½åè¿›åˆ¶æ•´æ•°ï¼ˆ0..99999999ï¼‰
  function feistelEnc8(n8, keyStr){
    let L = Math.floor(n8 / 10000);
    let R = n8 % 10000;
    for(let r=1; r<=6; r++){
      const F = roundPRF(R, r, keyStr) % 10000;
      const newL = R;
      const newR = (L ^ F) % 10000;
      L = newL; R = newR;
    }
    return L * 10000 + R;
  }
  function feistelDec8(n8, keyStr){
    let L = Math.floor(n8 / 10000);
    let R = n8 % 10000;
    for(let r=6; r>=1; r--){
      const F = roundPRF(L, r, keyStr) % 10000;
      const newR = L;
      const newL = (R ^ F) % 10000;
      L = newL; R = newR;
    }
    return L * 10000 + R;
  }

  // 8 ä½åè¿›åˆ¶ â†” å®šé•¿ 6 ä½ Base32
  function toBase32_6(n){
    let s = '';
    for(let i=0;i<6;i++){
      s = ALPH[n % RADIX] + s;
      n = Math.floor(n / RADIX);
    }
    return s;
  }
  function fromBase32_6(str){
    let n = 0;
    for(let i=0;i<6;i++){
      const v = ALPH.indexOf(str[i]);
      if(v < 0) return NaN;
      n = n * RADIX + v;
    }
    return n;
  }

  // === ADM å…¥å£ ===
  // åŠ å¯†ï¼šleft8(ä»¥7688å¼€å¤´) + right4 â†’ 6ä½ç¼–ç 
  function ADM_encrypt(left8, right4){
    const block8 = parseInt(left8.slice(4) + right4, 10); // å‚ä¸åŠ å¯†çš„ 8 ä½
    const mixed  = feistelEnc8(block8, ADM_KEY);
    return toBase32_6(mixed);
  }
  // è§£å¯†ï¼šcode6 â†’ { left8: '7688xxxx', right4: 'xxxx' }
  function ADM_decrypt(code6){
    const mixed = fromBase32_6(code6);
    if(!Number.isFinite(mixed)) return null;
    const block8 = feistelDec8(mixed, ADM_KEY);
    const s = String(block8).padStart(8,'0');
    return { left8: '7688' + s.slice(0,4), right4: s.slice(4) };
  }

  // ===== UI é€»è¾‘ =====
  const calcBtn = document.getElementById('calcBtn');
  const calcContainer = document.getElementById('calcContainer');
  const prefixInput = document.getElementById('prefixInput');
  const mainInput = document.getElementById('mainInput');
  const prefixOutput = document.getElementById('prefixOutput');
  const output = document.getElementById('output');

  function currentOp(){
    return document.querySelector('input[name="operation"]:checked').value;
  }

  function updateButtonStyle(){
    if(currentOp()==='encrypt'){
      calcBtn.textContent = 'ğŸ”’ è®¡ç®—';
      calcBtn.style.background = 'var(--blue)';
    }else{
      calcBtn.textContent = 'ğŸ”“ è®¡ç®—';
      calcBtn.style.background = 'var(--orange)';
    }
  }

  function flashModule(){
    const cls = currentOp()==='encrypt' ? 'flash-encrypt' : 'flash-decrypt';
    calcContainer.classList.add(cls);
    setTimeout(()=>{
      calcContainer.classList.remove(cls);
      // æ®‹ç•™æ·¡è‰²
      calcContainer.style.backgroundColor = (currentOp()==='encrypt')
        ? 'rgba(76,175,239,0.08)'
        : 'rgba(255,112,67,0.08)';
    }, 420);
  }

  function clearTint(){
    calcContainer.style.backgroundColor = 'transparent';
  }

  function logOperation(mode,op,input,outputStr){
    const log = document.getElementById('log');
    const t = new Date().toLocaleTimeString();
    log.innerHTML = `<div>[${t}] æ¨¡å¼:${mode} æ“ä½œ:${op} è¾“å…¥:${input} â†’ è¾“å‡º:${outputStr}</div>` + log.innerHTML;
  }

  // åˆ‡æ¢åŠ /è§£å¯†æ—¶é‡ç½®è¾“å…¥/è¾“å‡ºä¸æç¤º
  document.querySelectorAll('input[name="operation"]').forEach(r=>{
    r.addEventListener('change', ()=>{
      // æ¸…ç©ºå€¼
      mainInput.value = '';
      output.value = '';
      clearTint();

      if(currentOp()==='decrypt'){
        prefixInput.value = 'HT-';
        prefixOutput.value = '';        // è§£å¯†æ—¶ï¼Œè¾“å‡ºå·¦ä¸º 7688xxxxï¼ˆè®¡ç®—åå¡«å…¥ï¼‰
        mainInput.placeholder = 'è¾“å…¥6ä½ç¼–ç ï¼ˆå¤§å†™ï¼‰';
        mainInput.maxLength = 6;
      }else{
        prefixInput.value = '76880800';
        prefixOutput.value = 'HT-';     // åŠ å¯†æ—¶ï¼Œè¾“å‡ºå·¦å›ºå®š HT-
        mainInput.placeholder = 'è¾“å…¥4ä½æ•°å­—';
        mainInput.maxLength = 4;
      }
      updateButtonStyle();
    });
  });

  // è§£å¯†è¾“å…¥è‡ªåŠ¨è½¬å¤§å†™ & è¿‡æ»¤ä¸åœ¨å­—ç¬¦é›†çš„å­—ç¬¦
  mainInput.addEventListener('input', ()=>{
    if(currentOp()==='decrypt'){
      const up = mainInput.value.toUpperCase().replace(/[^0-9A-Z]/g,'');
      mainInput.value = up;
    }
  });

  function onCalculate(){
    flashModule();
    updateButtonStyle();

    const mode = document.querySelector('input[name="mode"]:checked').value;
    if(mode!=='ADM'){ alert('å½“å‰ä»…æ”¯æŒ ADM æ¨¡å¼'); return; }

    const op = currentOp();

    if(op==='encrypt'){
      const left = prefixInput.value.trim();
      const right = mainInput.value.trim();

      if(!/^\d{8}$/.test(left) || !left.startsWith('7688')){
        alert('å·¦è¾“å…¥éœ€ä¸º 8 ä½æ•°å­—ï¼Œä¸”ä»¥ 7688 å¼€å¤´'); return;
      }
      if(!/^\d{4}$/.test(right)){
        alert('å³è¾“å…¥éœ€ä¸º 4 ä½æ•°å­—'); return;
      }

      const code6 = ADM_encrypt(left, right);
      prefixOutput.value = 'HT-';
      output.value = code6;

      logOperation(mode, op, `${left}+${right}`, `HT-${code6}`);

    }else{ // decrypt
      const left = prefixInput.value.trim();
      const code = mainInput.value.trim().toUpperCase();

      if(left!=='HT-'){
        alert('è§£å¯†æ¨¡å¼ä¸‹ï¼Œå·¦è¾“å…¥å¿…é¡»ä¸º HT-'); return;
      }
      if(!/^[23456789ABCDEFGHJKLMNPRSTUVWXYZ]{6}$/.test(code)){
        alert('å³è¾“å…¥éœ€ä¸º 6 ä½ï¼ˆæ•°å­—æˆ–å¤§å†™å­—æ¯ï¼Œä¸”ä¸å« 0/O/1/Iï¼‰'); return;
      }

      const res = ADM_decrypt(code);
      if(!res){ alert('è§£å¯†å¤±è´¥ï¼šç¼–ç éæ³•'); return; }

      prefixOutput.value = res.left8;   // 7688 + 4 ä½
      output.value = res.right4;        // å 4 ä½

      logOperation(mode, op, `${left}${code}`, `${res.left8}${res.right4}`);
    }
  }

  // åˆå§‹æ ·å¼
  updateButtonStyle();
</script>
</body>
</html>
